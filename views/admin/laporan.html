<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Laporan - Balai Bahasa Provinsi Lampung</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <div class="container-fluid">
    <div class="row">
      <!-- Sidebar -->
      <div class="col-md-3 col-lg-2 sidebar">
        <h4 class="text-white mb-4">
          <i class="fas fa-user-shield me-2"></i>
          <span id="userName">Admin</span>
        </h4>
        <nav class="nav flex-column">
          <a class="nav-link" href="/admin/dashboard">
            <i class="fas fa-home"></i>Dashboard
          </a>
          <a class="nav-link" href="/admin/data-karyawan">
            <i class="fas fa-users"></i>Data Karyawan
          </a>
          <a class="nav-link" href="/admin/verifikasi-izin">
            <i class="fas fa-calendar-check"></i>Verifikasi Izin
          </a>
          <a class="nav-link" href="/admin/pelanggaran">
            <i class="fas fa-exclamation-triangle"></i>Pelanggaran
          </a>
          <a class="nav-link" href="/admin/konsultasi">
            <i class="fas fa-comment-dots"></i>Konsultasi
          </a>
          <a class="nav-link active" href="/admin/laporan">
            <i class="fas fa-chart-bar"></i>Laporan
          </a>
          <a class="nav-link" href="#" onclick="logout()">
            <i class="fas fa-sign-out-alt"></i>Logout
          </a>
        </nav>
      </div>

      <!-- Main Content -->
      <div class="col-md-9 col-lg-10 p-4">
        <h2 class="mb-4">
          <i class="fas fa-chart-bar me-2 text-primary"></i>
          Laporan & Statistik 
        </h2>

        <!-- Filter -->
        <div class="card mb-4 fade-in">
          <div class="card-body">
            <div class="row">
              <div class="col-md-3">
                <label class="form-label">Bulan</label>
                <select class="form-select" id="filterBulan">
                  <option value="">Semua</option>
                  <option value="1">Januari</option>
                  <option value="2">Februari</option>
                  <option value="3">Maret</option>
                  <option value="4">April</option>
                  <option value="5">Mei</option>
                  <option value="6">Juni</option>
                  <option value="7">Juli</option>
                  <option value="8">Agustus</option>
                  <option value="9">September</option>
                  <option value="10">Oktober</option>
                  <option value="11">November</option>
                  <option value="12">Desember</option>
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label">Tahun</label>
                <select class="form-select" id="filterTahun"></select>
              </div>
              <div class="col-md-2">
                <label class="form-label">&nbsp;</label>
                <button class="btn btn-primary w-100" onclick="loadGrafikStatusIzin()">
                  <i class="fas fa-filter me-2"></i>Filter
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Charts -->
        <div class="row mb-4">
          <div class="col-md-6 mb-4">
            <div class="card fade-in">
              <div class="card-header">
                <h5 class="mb-0">
                  <i class="fas fa-chart-pie me-2"></i>
                  Status Izin Bulan Ini
                </h5>
              </div>
              <div class="card-body">
                <canvas id="chartStatusIzin" height="250"></canvas>
              </div>
            </div>
          </div>

          <div class="col-md-6 mb-4">
            <div class="card fade-in">
              <div class="card-header">
                <h5 class="mb-0">
                  <i class="fas fa-chart-bar me-2"></i>
                  Jenis Izin Terbanyak
                </h5>
              </div>
              <div class="card-body">
                <canvas id="chartJenisIzin" height="250"></canvas>
              </div>
            </div>
          </div>
        </div>

        <div class="row mb-4">
          <div class="col-md-6 mb-4">
            <div class="card fade-in">
              <div class="card-header">
                <h5 class="mb-0">
                  <i class="fas fa-chart-line me-2"></i>
                  Tren Izin 3 Bulan Terakhir
                </h5>
              </div>
              <div class="card-body">
                <canvas id="chartTrenIzin" height="250"></canvas>
              </div>
            </div>
          </div>

          <div class="col-md-6 mb-4">
            <div class="card fade-in">
              <div class="card-header">
                <h5 class="mb-0">
                  <i class="fas fa-chart-bar me-2"></i>
                  Distribusi Izin per Jabatan
                </h5>
              </div>
              <div class="card-body">
                <canvas id="chartIzinJabatan" height="250"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="/js/main.js"></script>
  <script src="/js/chart-config.js"></script>
  <script>
    let chartStatusIzin, chartJenisIzin, chartTrenIzin, chartIzinJabatan;

    async function checkAuth() {
      const session = await checkSession();
      if (!session || session.role !== 'admin') {
        window.location.href = '/login';
        return false;
      }
      document.getElementById('userName').textContent = session.nama;
      return true;
    }

    // Populate tahun filter
    const currentYear = new Date().getFullYear();
    const filterTahun = document.getElementById('filterTahun');
    filterTahun.innerHTML = '<option value="">Semua</option>';
    for (let year = currentYear; year >= currentYear - 5; year--) {
      filterTahun.innerHTML += `<option value="${year}">${year}</option>`;
    }

    async function loadGrafikStatusIzin() {
      const bulan = document.getElementById('filterBulan').value;
      const tahun = document.getElementById('filterTahun').value;
      let url = '/api/admin/laporan/status-izin';
      
      if (bulan || tahun) {
        url += `?bulan=${bulan}&tahun=${tahun}`;
      }

      try {
        const response = await fetch(url);
        const data = await response.json();
        
        if (data.success && data.data.length > 0) {
          const labels = data.data.map(item => {
            return item.status.charAt(0).toUpperCase() + item.status.slice(1);
          });
          const values = data.data.map(item => item.jumlah);
          
          if (chartStatusIzin) {
            chartStatusIzin.destroy();
          }
          
          chartStatusIzin = createPieChart(
            'chartStatusIzin',
            labels,
            values,
            'Status Izin'
          );
        }
      } catch (error) {
        console.error('Error loading chart:', error);
      }
    }

    async function loadGrafikJenisIzin() {
      try {
        const response = await fetch('/api/admin/laporan/jenis-izin');
        const data = await response.json();
        
        if (data.success && data.data.length > 0) {
          const labels = data.data.map(item => item.jenis_izin);
          const values = data.data.map(item => item.jumlah);
          
          if (chartJenisIzin) {
            chartJenisIzin.destroy();
          }
          
          chartJenisIzin = createBarChart(
            'chartJenisIzin',
            labels,
            values,
            'Jumlah per Jenis Izin'
          );
        }
      } catch (error) {
        console.error('Error loading chart:', error);
      }
    }

    async function loadGrafikTrenIzin() {
      try {
        const response = await fetch('/api/admin/laporan/tren-izin');
        const data = await response.json();
        
        if (data.success && data.data.length > 0) {
          const labels = data.data.map(item => {
            const [year, month] = item.bulan.split('-');
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Agu', 'Sep', 'Okt', 'Nov', 'Des'];
            return `${monthNames[parseInt(month) - 1]} ${year}`;
          });
          const values = data.data.map(item => item.jumlah);
          
          if (chartTrenIzin) {
            chartTrenIzin.destroy();
          }
          
          chartTrenIzin = createLineChart(
            'chartTrenIzin',
            labels,
            values,
            'Tren Izin'
          );
        }
      } catch (error) {
        console.error('Error loading chart:', error);
      }
    }

    async function loadGrafikIzinJabatan() {
      try {
        const response = await fetch('/api/admin/laporan/izin-per-jabatan');
        const data = await response.json();
        
        if (data.success && data.data.length > 0) {
          const labels = data.data.map(item => item.jabatan);
          const values = data.data.map(item => item.jumlah);
          
          if (chartIzinJabatan) {
            chartIzinJabatan.destroy();
          }
          
          chartIzinJabatan = createBarChart(
            'chartIzinJabatan',
            labels,
            values,
            'Jumlah Izin per Jabatan',
            true // horizontal
          );
        }
      } catch (error) {
        console.error('Error loading chart:', error);
      }
    }

    document.addEventListener('DOMContentLoaded', async () => {
      if (await checkAuth()) {
        loadGrafikStatusIzin();
        loadGrafikJenisIzin();
        loadGrafikTrenIzin();
        loadGrafikIzinJabatan();
      }
    });
  </script>
</body>
</html>